import"./modulepreload-polyfill-B5Qt9EMX.js";import{a as T,l as I}from"./firebase-BrtCog--.js";const h={API_TIMEOUT:15e3,MAX_RETRIES:3,RETRY_DELAY:1e3,BACKEND_URL:"https://binarybandits-matchmakingapi.onrender.com"},A=e=>new Promise(t=>setTimeout(t,e));async function C(e,t={},o=h.API_TIMEOUT){const n=new AbortController,s=setTimeout(()=>n.abort(),o);try{const r=await fetch(e,{...t,signal:n.signal});return clearTimeout(s),r}catch(r){throw clearTimeout(s),r.name==="AbortError"?new Error("Request timed out. Please check your connection."):r}}async function b(e,t={},o=h.MAX_RETRIES){let n;for(let s=0;s<o;s++)try{return await C(e,t)}catch(r){n=r,console.warn(`Attempt ${s+1} failed:`,r.message),s<o-1&&await A(h.RETRY_DELAY*Math.pow(2,s))}throw n}async function M(){const e=document.getElementById("language");if(!e){console.error("Language dropdown not found");return}e.innerHTML='<option value="">Loading languages...</option>',e.disabled=!0;try{const t=await b("https://api.languagetoolplus.com/v2/languages",{},2);if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const o=await t.json();if(!Array.isArray(o)||o.length===0)throw new Error("Invalid language data received");const n=new Set;if(o.forEach(r=>{r&&r.name&&typeof r.name=="string"&&n.add(r.name.split("(")[0].trim())}),n.size===0)throw new Error("No valid languages found");const s=Array.from(n).sort();e.innerHTML='<option value="">-- Select Language --</option>',s.forEach(r=>{const l=document.createElement("option");l.textContent=r,l.value=r.toLowerCase().replace(/\s+/g,"-"),e.appendChild(l)}),e.disabled=!1}catch(t){console.error("Error loading languages:",t);const o=["english","spanish","french","german","italian","portuguese","chinese","japanese","korean","arabic"];e.innerHTML='<option value="">-- Select Language --</option>',o.forEach(n=>{const s=document.createElement("option");s.textContent=n,s.value=n.toLowerCase(),e.appendChild(s)}),e.disabled=!1,d("Languages loaded from cache. Some options may be limited.",3e3)}}function S(){const e=document.getElementById("logoutBtn");if(!e){console.warn("Logout button not found");return}e.addEventListener("click",async t=>{if(t.preventDefault(),e.disabled)return;e.disabled=!0;const o=e.textContent;e.textContent="Logging out...";try{await I(),window.location.href="../pages/login.html"}catch(n){console.error("Logout error:",n),d("Logout failed. Redirecting anyway..."),setTimeout(()=>{window.location.href="../pages/login.html"},1500)}finally{e.disabled=!1,e.textContent=o}})}function k(e,t,o){const n=[];return(!e||e.trim()==="")&&n.push("Please select a language"),(!t||t.trim()==="")&&n.push("Please select a region"),(!o||o.trim()==="")&&n.push("Please select an interest"),n}function d(e,t=5e3){const o=document.getElementById("errorMessage"),n=document.getElementById("errorText");o&&n&&(n.textContent=e,o.classList.add("show"),t>0&&setTimeout(()=>o.classList.remove("show"),t))}function E(e,t=3e3){const o=document.getElementById("successMessage");if(o){const n=o.querySelector("span:last-child");n&&(n.textContent=e),o.classList.add("show"),t>0&&setTimeout(()=>o.classList.remove("show"),t)}}function P(){const e=document.getElementById("penpalForm");if(!e){console.error("Form not found");return}const t=document.getElementById("submitBtn"),o=document.getElementById("successMessage"),n=document.getElementById("errorMessage");e.addEventListener("submit",async r=>{r.preventDefault(),o?.classList.remove("show"),n?.classList.remove("show");const l=e.language?.value?.trim()||"",p=e.region?.value?.trim()||"",w=e.interest?.value?.trim()||"",y=k(l,p,w);if(y.length>0){d(y.join(". "));return}t.disabled=!0;const v=t.textContent;t.innerHTML='<span class="loading-spinner"></span>Searching...';const f=e.querySelectorAll("select");f.forEach(a=>a.disabled=!0);try{const a=T.currentUser;if(!a)throw new Error("You must be logged in to find a pen pal");const c=await Promise.race([a.getIdToken(),new Promise((i,m)=>setTimeout(()=>m(new Error("Authentication timeout")),5e3))]);E("Searching for your perfect match...");const u=await b(h.BACKEND_URL,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`},body:JSON.stringify({language:l.toLowerCase(),region:p,interest:w})});if(!u.ok){let i="Matchmaking failed";try{const m=await u.json();i=m.error||m.message||i}catch{i=`Server error (${u.status})`}throw new Error(i)}const g=await u.json();if(!g)throw new Error("Invalid response from server");if(g.match){const i=g.match.username||g.match.name||g.match.id||"a pen pal";E(`Great! You've been matched with ${i}!`),setTimeout(()=>{window.location.href="userdashboard.html"},2e3)}else d("No matches found. Try adjusting your preferences or check back later!",0),f.forEach(i=>i.disabled=!1)}catch(a){console.error("Error finding pen pal:",a);let c="Something went wrong. Please try again.";a.message.includes("logged in")?(c="Please log in to continue.",setTimeout(()=>window.location.href="../pages/login.html",2e3)):a.message.includes("timeout")||a.message.includes("timed out")?c="Connection timeout. Please check your internet and try again.":a.message.includes("Network")||a.message.includes("Failed to fetch")?c="Network error. Please check your connection.":a.message&&(c=a.message),d(c,0),f.forEach(u=>u.disabled=!1)}finally{t.disabled=!1,t.textContent=v}}),e.querySelectorAll("select").forEach(r=>{r.addEventListener("change",()=>{n?.classList.remove("show")})})}function B(){return new Promise(e=>{const t=T.onAuthStateChanged(o=>{t(),o||(console.warn("User not authenticated"),window.location.href="../pages/login.html"),e(o)},o=>{console.error("Auth state error:",o),t(),e(null)})})}async function L(){try{await B(),await M(),S(),P(),console.log("Application initialized successfully")}catch(e){console.error("Initialization error:",e),d("Failed to initialize application. Please refresh the page.")}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",L):L();
