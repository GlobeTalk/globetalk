import"./modulepreload-polyfill-B5Qt9EMX.js";import{_ as et}from"./preload-helper-BXl3LOEh.js";import{o as Ut,c as zt}from"./firebase-BrtCog--.js";function ee(t){if(typeof t!="string"||!t)throw new Error("expected a non-empty string, got: "+t)}function pe(t){if(typeof t!="number")throw new Error("expected a number, got: "+t)}const Ht=1,Gt=1,N="emoji",K="keyvalue",$e="favorites",Kt="tokens",tt="tokens",Wt="unicode",nt="count",Vt="group",Yt="order",ot="group-order",je="eTag",se="url",Ge="skinTone",Y="readonly",Le="readwrite",it="skinUnicodes",qt="skinUnicodes",Xt="https://cdn.jsdelivr.net/npm/emoji-picker-element-data@^1/en/emojibase/data.json",Jt="en";function Zt(t,e){const n=new Set,i=[];for(const r of t){const o=e(r);n.has(o)||(n.add(o),i.push(r))}return i}function Ke(t){return Zt(t,e=>e.unicode)}function Qt(t){function e(n,i,r){const o=i?t.createObjectStore(n,{keyPath:i}):t.createObjectStore(n);if(r)for(const[s,[c,l]]of Object.entries(r))o.createIndex(s,c,{multiEntry:l});return o}e(K),e(N,Wt,{[tt]:[Kt,!0],[ot]:[[Vt,Yt]],[it]:[qt,!0]}),e($e,void 0,{[nt]:[""]})}const xe={},oe={},ce={};function rt(t,e,n){n.onerror=()=>e(n.error),n.onblocked=()=>e(new Error("IDB blocked")),n.onsuccess=()=>t(n.result)}async function en(t){const e=await new Promise((n,i)=>{const r=indexedDB.open(t,Ht);xe[t]=r,r.onupgradeneeded=o=>{o.oldVersion<Gt&&Qt(r.result)},rt(n,i,r)});return e.onclose=()=>Be(t),e}function tn(t){return oe[t]||(oe[t]=en(t)),oe[t]}function O(t,e,n,i){return new Promise((r,o)=>{const s=t.transaction(e,n,{durability:"relaxed"}),c=typeof e=="string"?s.objectStore(e):e.map(d=>s.objectStore(d));let l;i(c,s,d=>{l=d}),s.oncomplete=()=>r(l),s.onerror=()=>o(s.error)})}function Be(t){const e=xe[t],n=e&&e.result;if(n){n.close();const i=ce[t];if(i)for(const r of i)r()}delete xe[t],delete oe[t],delete ce[t]}function nn(t){return new Promise((e,n)=>{Be(t);const i=indexedDB.deleteDatabase(t);rt(e,n,i)})}function on(t,e){let n=ce[t];n||(n=ce[t]=[]),n.push(e)}const rn=new Set([":D","XD",":'D","O:)",":X",":P",";P","XP",":L",":Z",":j","8D","XO","8)",":B",":O",":S",":'o","Dx","X(","D:",":C",">0)",":3","</3","<3","\\M/",":E","8#"]);function H(t){return t.split(/[\s_]+/).map(e=>!e.match(/\w/)||rn.has(e)?e.toLowerCase():e.replace(/[)(:,]/g,"").replace(/’/g,"'").toLowerCase()).filter(Boolean)}const an=2;function at(t){return t.filter(Boolean).map(e=>e.toLowerCase()).filter(e=>e.length>=an)}function sn(t){return t.map(({annotation:n,emoticon:i,group:r,order:o,shortcodes:s,skins:c,tags:l,emoji:d,version:f})=>{const h=[...new Set(at([...(s||[]).map(H).flat(),...(l||[]).map(H).flat(),...H(n),i]))].sort(),m={annotation:n,group:r,order:o,tags:l,tokens:h,unicode:d,version:f};if(i&&(m.emoticon=i),s&&(m.shortcodes=s),c){m.skinTones=[],m.skinUnicodes=[],m.skinVersions=[];for(const{tone:p,emoji:T,version:C}of c)m.skinTones.push(p),m.skinUnicodes.push(T),m.skinVersions.push(C)}return m})}function st(t,e,n,i){t[e](n).onsuccess=r=>i&&i(r.target.result)}function R(t,e,n){st(t,"get",e,n)}function ct(t,e,n){st(t,"getAll",e,n)}function De(t){t.commit&&t.commit()}function cn(t,e){let n=t[0];for(let i=1;i<t.length;i++){const r=t[i];e(n)>e(r)&&(n=r)}return n}function lt(t,e){const n=cn(t,r=>r.length),i=[];for(const r of n)t.some(o=>o.findIndex(s=>e(s)===e(r))===-1)||i.push(r);return i}async function ln(t){return!await Oe(t,K,se)}async function dn(t,e,n){const[i,r]=await Promise.all([je,se].map(o=>Oe(t,K,o)));return i===n&&r===e}async function un(t,e){return O(t,N,Y,(i,r,o)=>{let s;const c=()=>{i.getAll(s&&IDBKeyRange.lowerBound(s,!0),50).onsuccess=l=>{const d=l.target.result;for(const f of d)if(s=f.unicode,e(f))return o(f);if(d.length<50)return o();c()}};c()})}async function dt(t,e,n,i){try{const r=sn(e);await O(t,[N,K],Le,([o,s],c)=>{let l,d,f=0;function h(){++f===2&&m()}function m(){if(!(l===i&&d===n)){o.clear();for(const p of r)o.put(p);s.put(i,je),s.put(n,se),De(c)}}R(s,je,p=>{l=p,h()}),R(s,se,p=>{d=p,h()})})}finally{}}async function fn(t,e){return O(t,N,Y,(n,i,r)=>{const o=IDBKeyRange.bound([e,0],[e+1,0],!1,!0);ct(n.index(ot),o,r)})}async function ut(t,e){const n=at(H(e));return n.length?O(t,N,Y,(i,r,o)=>{const s=[],c=()=>{s.length===n.length&&l()},l=()=>{const d=lt(s,f=>f.unicode);o(d.sort((f,h)=>f.order<h.order?-1:1))};for(let d=0;d<n.length;d++){const f=n[d],h=d===n.length-1?IDBKeyRange.bound(f,f+"￿",!1,!0):IDBKeyRange.only(f);ct(i.index(tt),h,m=>{s.push(m),c()})}}):[]}async function mn(t,e){const n=await ut(t,e);return n.length?n.filter(i=>(i.shortcodes||[]).map(o=>o.toLowerCase()).includes(e.toLowerCase()))[0]||null:await un(t,r=>(r.shortcodes||[]).includes(e.toLowerCase()))||null}async function hn(t,e){return O(t,N,Y,(n,i,r)=>R(n,e,o=>{if(o)return r(o);R(n.index(it),e,s=>r(s||null))}))}function Oe(t,e,n){return O(t,e,Y,(i,r,o)=>R(i,n,o))}function pn(t,e,n,i){return O(t,e,Le,(r,o)=>{r.put(i,n),De(o)})}function gn(t,e){return O(t,$e,Le,(n,i)=>R(n,e,r=>{n.put((r||0)+1,e),De(i)}))}function bn(t,e,n){return n===0?[]:O(t,[$e,N],Y,([i,r],o,s)=>{const c=[];i.index(nt).openCursor(void 0,"prev").onsuccess=l=>{const d=l.target.result;if(!d)return s(c);function f(p){if(c.push(p),c.length===n)return s(c);d.continue()}const h=d.primaryKey,m=e.byName(h);if(m)return f(m);R(r,h,p=>{if(p)return f(p);d.continue()})}})}const te="";function yn(t,e){const n=new Map;for(const r of t){const o=e(r);for(const s of o){let c=n;for(let d=0;d<s.length;d++){const f=s.charAt(d);let h=c.get(f);h||(h=new Map,c.set(f,h)),c=h}let l=c.get(te);l||(l=[],c.set(te,l)),l.push(r)}}return(r,o)=>{let s=n;for(let d=0;d<r.length;d++){const f=r.charAt(d),h=s.get(f);if(h)s=h;else return[]}if(o)return s.get(te)||[];const c=[],l=[s];for(;l.length;){const f=[...l.shift().entries()].sort((h,m)=>h[0]<m[0]?-1:1);for(const[h,m]of f)h===te?c.push(...m):l.push(m)}return c}}const kn=["name","url"];function vn(t){const e=t&&Array.isArray(t),n=e&&t.length&&(!t[0]||kn.some(i=>!(i in t[0])));if(!e||n)throw new Error("Custom emojis are in the wrong format")}function We(t){vn(t);const e=(m,p)=>m.name.toLowerCase()<p.name.toLowerCase()?-1:1,n=t.sort(e),r=yn(t,m=>{const p=new Set;if(m.shortcodes)for(const T of m.shortcodes)for(const C of H(T))p.add(C);return p}),o=m=>r(m,!0),s=m=>r(m,!1),c=m=>{const p=H(m),T=p.map((C,$)=>($<p.length-1?o:s)(C));return lt(T,C=>C.name).sort(e)},l=new Map,d=new Map;for(const m of t){d.set(m.name.toLowerCase(),m);for(const p of m.shortcodes||[])l.set(p.toLowerCase(),m)}return{all:n,search:c,byShortcode:m=>l.get(m.toLowerCase()),byName:m=>d.get(m.toLowerCase())}}const En=typeof wrappedJSObject<"u";function X(t){if(!t)return t;if(En&&(t=structuredClone(t)),delete t.tokens,t.skinTones){const e=t.skinTones.length;t.skins=Array(e);for(let n=0;n<e;n++)t.skins[n]={tone:t.skinTones[n],unicode:t.skinUnicodes[n],version:t.skinVersions[n]};delete t.skinTones,delete t.skinUnicodes,delete t.skinVersions}return t}function ft(t){t||console.warn("emoji-picker-element is more efficient if the dataSource server exposes an ETag header.")}const wn=["annotation","emoji","group","order","version"];function Tn(t){if(!t||!Array.isArray(t)||!t[0]||typeof t[0]!="object"||wn.some(e=>!(e in t[0])))throw new Error("Emoji data is in the wrong format")}function mt(t,e){if(Math.floor(t.status/100)!==2)throw new Error("Failed to fetch: "+e+":  "+t.status)}async function Sn(t){const e=await fetch(t,{method:"HEAD"});mt(e,t);const n=e.headers.get("etag");return ft(n),n}async function Ie(t){const e=await fetch(t);mt(e,t);const n=e.headers.get("etag");ft(n);const i=await e.json();return Tn(i),[n,i]}function jn(t){for(var e="",n=new Uint8Array(t),i=n.byteLength,r=-1;++r<i;)e+=String.fromCharCode(n[r]);return e}function xn(t){for(var e=t.length,n=new ArrayBuffer(e),i=new Uint8Array(n),r=-1;++r<e;)i[r]=t.charCodeAt(r);return n}async function ht(t){const e=JSON.stringify(t);let n=xn(e);const i=await crypto.subtle.digest("SHA-1",n),r=jn(i);return btoa(r)}async function In(t,e){let n,i=await Sn(e);if(!i){const r=await Ie(e);i=r[0],n=r[1],i||(i=await ht(n))}await dn(t,e,i)||(n||(n=(await Ie(e))[1]),await dt(t,n,e,i))}async function Cn(t,e){let[n,i]=await Ie(e);n||(n=await ht(i)),await dt(t,i,e,n)}async function _n(t,e){try{await In(t,e)}catch(n){if(n.name!=="InvalidStateError")throw n}}class An{constructor({dataSource:e=Xt,locale:n=Jt,customEmoji:i=[]}={}){this.dataSource=e,this.locale=n,this._dbName=`emoji-picker-element-${this.locale}`,this._db=void 0,this._lazyUpdate=void 0,this._custom=We(i),this._clear=this._clear.bind(this),this._ready=this._init()}async _init(){const e=this._db=await tn(this._dbName);on(this._dbName,this._clear);const n=this.dataSource;await ln(e)?await Cn(e,n):this._lazyUpdate=_n(e,n)}async ready(){const e=async()=>(this._ready||(this._ready=this._init()),this._ready);await e(),this._db||await e()}async getEmojiByGroup(e){return pe(e),await this.ready(),Ke(await fn(this._db,e)).map(X)}async getEmojiBySearchQuery(e){ee(e),await this.ready();const n=this._custom.search(e),i=Ke(await ut(this._db,e)).map(X);return[...n,...i]}async getEmojiByShortcode(e){ee(e),await this.ready();const n=this._custom.byShortcode(e);return n||X(await mn(this._db,e))}async getEmojiByUnicodeOrName(e){ee(e),await this.ready();const n=this._custom.byName(e);return n||X(await hn(this._db,e))}async getPreferredSkinTone(){return await this.ready(),await Oe(this._db,K,Ge)||0}async setPreferredSkinTone(e){return pe(e),await this.ready(),pn(this._db,K,Ge,e)}async incrementFavoriteEmojiCount(e){return ee(e),await this.ready(),gn(this._db,e)}async getTopFavoriteEmoji(e){return pe(e),await this.ready(),(await bn(this._db,this._custom,e)).map(X)}set customEmoji(e){this._custom=We(e)}get customEmoji(){return this._custom.all}async _shutdown(){await this.ready();try{await this._lazyUpdate}catch{}}_clear(){this._db=this._ready=this._lazyUpdate=void 0}async close(){await this._shutdown(),await Be(this._dbName)}async delete(){await this._shutdown(),await nn(this._dbName)}}const Ce=[[-1,"✨","custom"],[0,"😀","smileys-emotion"],[1,"👋","people-body"],[3,"🐱","animals-nature"],[4,"🍎","food-drink"],[5,"🏠️","travel-places"],[6,"⚽","activities"],[7,"📝","objects"],[8,"⛔️","symbols"],[9,"🏁","flags"]].map(([t,e,n])=>({id:t,emoji:e,name:n})),ge=Ce.slice(1),$n=2,Ve=6,pt=typeof requestIdleCallback=="function"?requestIdleCallback:setTimeout;function Ye(t){return t.unicode.includes("‍")}const Ln={"🫩":16,"🫨":15.1,"🫠":14,"🥲":13.1,"🥻":12.1,"🥰":11,"🤩":5,"👱‍♀️":4,"🤣":3,"👁️‍🗨️":2,"😀":1,"😐️":.7,"😃":.6},Bn=1e3,Dn="🖐️",On=8,Mn=["😊","😒","❤️","👍️","😍","😂","😭","☺️","😔","😩","😏","💕","🙌","😘"],gt='"Twemoji Mozilla","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji","EmojiOne Color","Android Emoji",sans-serif',Pn=(t,e)=>t<e?-1:t>e?1:0,qe=(t,e)=>{const n=document.createElement("canvas");n.width=n.height=1;const i=n.getContext("2d",{willReadFrequently:!0});return i.textBaseline="top",i.font=`100px ${gt}`,i.fillStyle=e,i.scale(.01,.01),i.fillText(t,0,0),i.getImageData(0,0,1,1).data},Rn=(t,e)=>{const n=[...t].join(","),i=[...e].join(",");return n===i&&!n.startsWith("0,0,0,")};function Fn(t){const e=qe(t,"#000"),n=qe(t,"#fff");return e&&n&&Rn(e,n)}function Nn(){const t=Object.entries(Ln);try{for(const[e,n]of t)if(Fn(e))return n}catch{}finally{}return t[0][1]}let be;const ye=()=>(be||(be=new Promise(t=>pt(()=>t(Nn())))),be),_e=new Map,Un="️",zn="\uD83C",Hn="‍",Gn=127995,Kn=57339;function Wn(t,e){if(e===0)return t;const n=t.indexOf(Hn);return n!==-1?t.substring(0,n)+String.fromCodePoint(Gn+e-1)+t.substring(n):(t.endsWith(Un)&&(t=t.substring(0,t.length-1)),t+zn+String.fromCodePoint(Kn+e-1))}function B(t){t.preventDefault(),t.stopPropagation()}function ke(t,e,n){return e+=t?-1:1,e<0?e=n.length-1:e>=n.length&&(e=0),e}function bt(t,e){const n=new Set,i=[];for(const r of t){const o=e(r);n.has(o)||(n.add(o),i.push(r))}return i}function Vn(t,e){const n=i=>{const r={};for(const o of i)typeof o.tone=="number"&&o.version<=e&&(r[o.tone]=o.unicode);return r};return t.map(({unicode:i,skins:r,shortcodes:o,url:s,name:c,category:l,annotation:d})=>({unicode:i,name:c,shortcodes:o,url:s,category:l,annotation:d,id:i||c,skins:r&&n(r)}))}const ie=requestAnimationFrame;let Yn=typeof ResizeObserver=="function";function qn(t,e,n){let i;Yn?(i=new ResizeObserver(n),i.observe(t)):ie(n),e.addEventListener("abort",()=>{i&&i.disconnect()})}function Xe(t){{const e=document.createRange();return e.selectNode(t.firstChild),e.getBoundingClientRect().width}}let ve;function Xn(t,e,n){let i=!0;for(const r of t){const o=n(r);if(!o)continue;const s=Xe(o);typeof ve>"u"&&(ve=Xe(e));const c=s/1.8<ve;_e.set(r.unicode,c),c||(i=!1)}return i}function Jn(t){return bt(t,e=>e)}function Zn(t){t&&(t.scrollTop=0)}function J(t,e,n){let i=t.get(e);return i||(i=n(),t.set(e,i)),i}function Je(t){return""+t}function Qn(t){const e=document.createElement("template");return e.innerHTML=t,e}const eo=new WeakMap,to=new WeakMap,no=Symbol("un-keyed"),oo="replaceChildren"in Element.prototype;function io(t,e){oo?t.replaceChildren(...e):(t.innerHTML="",t.append(...e))}function ro(t,e){let n=t.firstChild,i=0;for(;n;){if(e[i]!==n)return!0;n=n.nextSibling,i++}return i!==e.length}function ao(t,e){const{targetNode:n}=e;let{targetParentNode:i}=e,r=!1;i?r=ro(i,t):(r=!0,e.targetNode=void 0,e.targetParentNode=i=n.parentNode),r&&io(i,t)}function so(t,e){for(const n of e){const{targetNode:i,currentExpression:r,binding:{expressionIndex:o,attributeName:s,attributeValuePre:c,attributeValuePost:l}}=n,d=t[o];if(r!==d)if(n.currentExpression=d,s)if(d===null)i.removeAttribute(s);else{const f=c+Je(d)+l;i.setAttribute(s,f)}else{let f;Array.isArray(d)?ao(d,n):d instanceof Element?(f=d,i.replaceWith(f)):i.nodeValue=Je(d),f&&(n.targetNode=f)}}}function co(t){let e="",n=!1,i=!1,r=-1;const o=new Map,s=[];let c=0;for(let d=0,f=t.length;d<f;d++){const h=t[d];if(e+=h.slice(c),d===f-1)break;for(let g=0;g<h.length;g++)switch(h.charAt(g)){case"<":{h.charAt(g+1)==="/"?s.pop():(n=!0,s.push(++r));break}case">":{n=!1,i=!1;break}case"=":{i=!0;break}}const m=s[s.length-1],p=J(o,m,()=>[]);let T,C,$;if(i){const g=/(\S+)="?([^"=]*)$/.exec(h);T=g[1],C=g[2];const k=/^([^">]*)("?)/.exec(t[d+1]);$=k[1],e=e.slice(0,-1*g[0].length),c=k[0].length}else c=0;const U={attributeName:T,attributeValuePre:C,attributeValuePost:$,expressionIndex:d};p.push(U),!n&&!i&&(e+=" ")}return{template:Qn(e),elementsToBindings:o}}function Ze(t,e,n){for(let i=0;i<t.length;i++){const r=t[i],o=r.attributeName?e:e.firstChild,s={binding:r,targetNode:o,targetParentNode:void 0,currentExpression:void 0};n.push(s)}}function lo(t,e){const n=[];let i;if(e.size===1&&(i=e.get(0)))Ze(i,t,n);else{const r=document.createTreeWalker(t,NodeFilter.SHOW_ELEMENT);let o=t,s=-1;do{const c=e.get(++s);c&&Ze(c,o,n)}while(o=r.nextNode())}return n}function uo(t){const{template:e,elementsToBindings:n}=J(eo,t,()=>co(t)),i=e.cloneNode(!0).content.firstElementChild,r=lo(i,n);return function(s){return so(s,r),i}}function fo(t){const e=J(to,t,()=>new Map);let n=no;function i(o,...s){const c=J(e,o,()=>new Map);return J(c,n,()=>uo(o))(s)}function r(o,s,c){return o.map((l,d)=>{const f=n;n=c(l);try{return s(l,d)}finally{n=f}})}return{map:r,html:i}}function mo(t,e,n,i,r,o,s,c,l){const{labelWithSkin:d,titleForEmoji:f,unicodeWithSkin:h}=n,{html:m,map:p}=fo(e);function T(g,k,I){return p(g,(_,q)=>m`<button role="${k?"option":"menuitem"}" aria-selected="${k?q===e.activeSearchItem:null}" aria-label="${d(_,e.currentSkinTone)}" title="${f(_)}" class="${"emoji"+(k&&q===e.activeSearchItem?" active":"")+(_.unicode?"":" custom-emoji")}" id="${`${I}-${_.id}`}" style="${_.unicode?null:`--custom-emoji-background: url(${JSON.stringify(_.url)})`}">${_.unicode?h(_,e.currentSkinTone):""}</button>`,_=>`${I}-${_.id}`)}const $=m`<section data-ref="rootElement" class="picker" aria-label="${e.i18n.regionLabel}" style="${e.pickerStyle||""}"><div class="pad-top"></div><div class="search-row"><div class="search-wrapper"><input id="search" class="search" type="search" role="combobox" enterkeyhint="search" placeholder="${e.i18n.searchLabel}" autocapitalize="none" autocomplete="off" spellcheck="true" aria-expanded="${!!(e.searchMode&&e.currentEmojis.length)}" aria-controls="search-results" aria-describedby="search-description" aria-autocomplete="list" aria-activedescendant="${e.activeSearchItemId?`emo-${e.activeSearchItemId}`:null}" data-ref="searchElement" data-on-input="onSearchInput" data-on-keydown="onSearchKeydown"><label class="sr-only" for="search">${e.i18n.searchLabel}</label> <span id="search-description" class="sr-only">${e.i18n.searchDescription}</span></div><div class="skintone-button-wrapper ${e.skinTonePickerExpandedAfterAnimation?"expanded":""}"><button id="skintone-button" class="emoji ${e.skinTonePickerExpanded?"hide-focus":""}" aria-label="${e.skinToneButtonLabel}" title="${e.skinToneButtonLabel}" aria-describedby="skintone-description" aria-haspopup="listbox" aria-expanded="${e.skinTonePickerExpanded}" aria-controls="skintone-list" data-on-click="onClickSkinToneButton">${e.skinToneButtonText||""}</button></div><span id="skintone-description" class="sr-only">${e.i18n.skinToneDescription}</span><div data-ref="skinToneDropdown" id="skintone-list" class="skintone-list hide-focus ${e.skinTonePickerExpanded?"":"hidden no-animate"}" style="transform:translateY(${e.skinTonePickerExpanded?0:"calc(-1 * var(--num-skintones) * var(--total-emoji-size))"})" role="listbox" aria-label="${e.i18n.skinTonesLabel}" aria-activedescendant="skintone-${e.activeSkinTone}" aria-hidden="${!e.skinTonePickerExpanded}" tabIndex="-1" data-on-focusout="onSkinToneOptionsFocusOut" data-on-click="onSkinToneOptionsClick" data-on-keydown="onSkinToneOptionsKeydown" data-on-keyup="onSkinToneOptionsKeyup">${p(e.skinTones,(g,k)=>m`<div id="skintone-${k}" class="emoji ${k===e.activeSkinTone?"active":""}" aria-selected="${k===e.activeSkinTone}" role="option" title="${e.i18n.skinTones[k]}" aria-label="${e.i18n.skinTones[k]}">${g}</div>`,g=>g)}</div></div><div class="nav" role="tablist" style="grid-template-columns:repeat(${e.groups.length},1fr)" aria-label="${e.i18n.categoriesLabel}" data-on-keydown="onNavKeydown" data-on-click="onNavClick">${p(e.groups,g=>m`<button role="tab" class="nav-button" aria-controls="tab-${g.id}" aria-label="${e.i18n.categories[g.name]}" aria-selected="${!e.searchMode&&e.currentGroup.id===g.id}" title="${e.i18n.categories[g.name]}" data-group-id="${g.id}"><div class="nav-emoji emoji">${g.emoji}</div></button>`,g=>g.id)}</div><div class="indicator-wrapper"><div class="indicator" style="transform:translateX(${(e.isRtl?-1:1)*e.currentGroupIndex*100}%)"></div></div><div class="message ${e.message?"":"gone"}" role="alert" aria-live="polite">${e.message||""}</div><div data-ref="tabpanelElement" class="tabpanel ${!e.databaseLoaded||e.message?"gone":""}" role="${e.searchMode?"region":"tabpanel"}" aria-label="${e.searchMode?e.i18n.searchResultsLabel:e.i18n.categories[e.currentGroup.name]}" id="${e.searchMode?null:`tab-${e.currentGroup.id}`}" tabIndex="0" data-on-click="onEmojiClick"><div data-action="calculateEmojiGridStyle">${p(e.currentEmojisWithCategories,(g,k)=>m`<div><div id="menu-label-${k}" class="category ${e.currentEmojisWithCategories.length===1&&e.currentEmojisWithCategories[0].category===""?"gone":""}" aria-hidden="true">${e.searchMode?e.i18n.searchResultsLabel:g.category?g.category:e.currentEmojisWithCategories.length>1?e.i18n.categories.custom:e.i18n.categories[e.currentGroup.name]}</div><div class="emoji-menu ${k!==0&&!e.searchMode&&e.currentGroup.id===-1?"visibility-auto":""}" style="${`--num-rows: ${Math.ceil(g.emojis.length/e.numColumns)}`}" data-action="updateOnIntersection" role="${e.searchMode?"listbox":"menu"}" aria-labelledby="menu-label-${k}" id="${e.searchMode?"search-results":null}">${T(g.emojis,e.searchMode,"emo")}</div></div>`,g=>g.category)}</div></div><div class="favorites onscreen emoji-menu ${e.message?"gone":""}" role="menu" aria-label="${e.i18n.favoritesLabel}" data-on-click="onEmojiClick">${T(e.currentFavorites,!1,"fav")}</div><button data-ref="baselineEmoji" aria-hidden="true" tabindex="-1" class="abs-pos hidden emoji baseline-emoji">😀</button></section>`,U=(g,k)=>{for(const I of t.querySelectorAll(`[${g}]`))k(I,I.getAttribute(g))};if(l){t.appendChild($);for(const g of["click","focusout","input","keydown","keyup"])U(`data-on-${g}`,(k,I)=>{k.addEventListener(g,i[I])});U("data-ref",(g,k)=>{o[k]=g}),s.addEventListener("abort",()=>{t.removeChild($)})}U("data-action",(g,k)=>{let I=c.get(k);I||c.set(k,I=new WeakSet),I.has(g)||(I.add(g),r[k](g))})}const le=typeof queueMicrotask=="function"?queueMicrotask:t=>Promise.resolve().then(t);function ho(t){let e=!1,n;const i=new Map,r=new Set;let o;const s=()=>{if(e)return;const d=[...r];r.clear();try{for(const f of d)f()}finally{o=!1,r.size&&(o=!0,le(s))}},c=new Proxy({},{get(d,f){if(n){let h=i.get(f);h||(h=new Set,i.set(f,h)),h.add(n)}return d[f]},set(d,f,h){if(d[f]!==h){d[f]=h;const m=i.get(f);if(m){for(const p of m)r.add(p);o||(o=!0,le(s))}}return!0}}),l=d=>{const f=()=>{const h=n;n=f;try{return d()}finally{n=h}};return f()};return t.addEventListener("abort",()=>{e=!0}),{state:c,createEffect:l}}function Ee(t,e,n){if(t.length!==e.length)return!1;for(let i=0;i<t.length;i++)if(!n(t[i],e[i]))return!1;return!0}const Qe=new WeakMap;function po(t,e,n){{const i=t.closest(".tabpanel");let r=Qe.get(i);r||(r=new IntersectionObserver(n,{root:i,rootMargin:"50% 0px 50% 0px",threshold:0}),Qe.set(i,r),e.addEventListener("abort",()=>{r.disconnect()})),r.observe(t)}}const we=[],{assign:ne}=Object;function go(t,e){const n={},i=new AbortController,r=i.signal,{state:o,createEffect:s}=ho(r),c=new Map;ne(o,{skinToneEmoji:void 0,i18n:void 0,database:void 0,customEmoji:void 0,customCategorySorting:void 0,emojiVersion:void 0}),ne(o,e),ne(o,{initialLoad:!0,currentEmojis:[],currentEmojisWithCategories:[],rawSearchText:"",searchText:"",searchMode:!1,activeSearchItem:-1,message:void 0,skinTonePickerExpanded:!1,skinTonePickerExpandedAfterAnimation:!1,currentSkinTone:0,activeSkinTone:0,skinToneButtonText:void 0,pickerStyle:void 0,skinToneButtonLabel:"",skinTones:[],currentFavorites:[],defaultFavoriteEmojis:void 0,numColumns:On,isRtl:!1,currentGroupIndex:0,groups:ge,databaseLoaded:!1,activeSearchItemId:void 0}),s(()=>{o.currentGroup!==o.groups[o.currentGroupIndex]&&(o.currentGroup=o.groups[o.currentGroupIndex])});const l=a=>{t.getElementById(a).focus()},d=a=>t.getElementById(`emo-${a.id}`),f=(a,u)=>{n.rootElement.dispatchEvent(new CustomEvent(a,{detail:u,bubbles:!0,composed:!0}))},h=(a,u)=>a.id===u.id,m=(a,u)=>{const{category:b,emojis:y}=a,{category:w,emojis:S}=u;return b!==w?!1:Ee(y,S,h)},p=a=>{Ee(o.currentEmojis,a,h)||(o.currentEmojis=a)},T=a=>{o.searchMode!==a&&(o.searchMode=a)},C=a=>{Ee(o.currentEmojisWithCategories,a,m)||(o.currentEmojisWithCategories=a)},$=(a,u)=>u&&a.skins&&a.skins[u]||a.unicode,k={labelWithSkin:(a,u)=>Jn([a.name||$(a,u),a.annotation,...a.shortcodes||we].filter(Boolean)).join(", "),titleForEmoji:a=>a.annotation||(a.shortcodes||we).join(", "),unicodeWithSkin:$},I={onClickSkinToneButton:Mt,onEmojiClick:Dt,onNavClick:$t,onNavKeydown:Lt,onSearchKeydown:At,onSkinToneOptionsClick:Ot,onSkinToneOptionsFocusOut:Ft,onSkinToneOptionsKeydown:Pt,onSkinToneOptionsKeyup:Rt,onSearchInput:Nt},_={calculateEmojiGridStyle:St,updateOnIntersection:jt};let q=!0;s(()=>{mo(t,o,k,I,_,n,r,c,q),q=!1}),o.emojiVersion||ye().then(a=>{a||(o.message=o.i18n.emojiUnsupportedMessage)}),s(()=>{async function a(){let u=!1;const b=setTimeout(()=>{u=!0,o.message=o.i18n.loadingMessage},Bn);try{await o.database.ready(),o.databaseLoaded=!0}catch(y){console.error(y),o.message=o.i18n.networkErrorMessage}finally{clearTimeout(b),u&&(u=!1,o.message="")}}o.database&&a()}),s(()=>{o.pickerStyle=`
      --num-groups: ${o.groups.length}; 
      --indicator-opacity: ${o.searchMode?0:1}; 
      --num-skintones: ${Ve};`}),s(()=>{o.customEmoji&&o.database&&Ne()}),s(()=>{o.customEmoji&&o.customEmoji.length?o.groups!==Ce&&(o.groups=Ce):o.groups!==ge&&(o.currentGroupIndex&&o.currentGroupIndex--,o.groups=ge)}),s(()=>{async function a(){o.databaseLoaded&&(o.currentSkinTone=await o.database.getPreferredSkinTone())}a()}),s(()=>{o.skinTones=Array(Ve).fill().map((a,u)=>Wn(o.skinToneEmoji,u))}),s(()=>{o.skinToneButtonText=o.skinTones[o.currentSkinTone]}),s(()=>{o.skinToneButtonLabel=o.i18n.skinToneLabel.replace("{skinTone}",o.i18n.skinTones[o.currentSkinTone])}),s(()=>{async function a(){const{database:u}=o,b=(await Promise.all(Mn.map(y=>u.getEmojiByUnicodeOrName(y)))).filter(Boolean);o.defaultFavoriteEmojis=b}o.databaseLoaded&&a()});function Ne(){const{customEmoji:a,database:u}=o,b=a||we;u.customEmoji!==b&&(u.customEmoji=b)}s(()=>{async function a(){Ne();const{database:u,defaultFavoriteEmojis:b,numColumns:y}=o,w=await u.getTopFavoriteEmoji(y),S=await me(bt([...w,...b],L=>L.unicode||L.name).slice(0,y));o.currentFavorites=S}o.databaseLoaded&&o.defaultFavoriteEmojis&&a()});function St(a){qn(a,r,()=>{{const u=getComputedStyle(n.rootElement),b=parseInt(u.getPropertyValue("--num-columns"),10),y=u.getPropertyValue("direction")==="rtl";o.numColumns=b,o.isRtl=y}})}function jt(a){po(a,r,u=>{for(const{target:b,isIntersecting:y}of u)b.classList.toggle("onscreen",y)})}s(()=>{async function a(){const{searchText:u,currentGroup:b,databaseLoaded:y,customEmoji:w}=o;if(!y)o.currentEmojis=[],o.searchMode=!1;else if(u.length>=$n){const S=await _t(u);o.searchText===u&&(p(S),T(!0))}else{const{id:S}=b;if(S!==-1||w&&w.length){const L=await Ct(S);o.currentGroup.id===S&&(p(L),T(!1))}}}a()});const Ue=()=>{ie(()=>Zn(n.tabpanelElement))};s(()=>{const{currentEmojis:a,emojiVersion:u}=o,b=a.filter(y=>y.unicode).filter(y=>Ye(y)&&!_e.has(y.unicode));if(!u&&b.length)p(a),ie(()=>xt(b));else{const y=u?a:a.filter(It);p(y),Ue()}});function xt(a){Xn(a,n.baselineEmoji,d)?Ue():o.currentEmojis=[...o.currentEmojis]}function It(a){return!a.unicode||!Ye(a)||_e.get(a.unicode)}async function ze(a){const u=o.emojiVersion||await ye();return a.filter(({version:b})=>!b||b<=u)}async function me(a){return Vn(a,o.emojiVersion||await ye())}async function Ct(a){const u=a===-1?o.customEmoji:await o.database.getEmojiByGroup(a);return me(await ze(u))}async function _t(a){return me(await ze(await o.database.getEmojiBySearchQuery(a)))}s(()=>{}),s(()=>{function a(){const{searchMode:b,currentEmojis:y}=o;if(b)return[{category:"",emojis:y}];const w=new Map;for(const S of y){const L=S.category||"";let Q=w.get(L);Q||(Q=[],w.set(L,Q)),Q.push(S)}return[...w.entries()].map(([S,L])=>({category:S,emojis:L})).sort((S,L)=>o.customCategorySorting(S.category,L.category))}const u=a();C(u)}),s(()=>{o.activeSearchItemId=o.activeSearchItem!==-1&&o.currentEmojis[o.activeSearchItem].id}),s(()=>{const{rawSearchText:a}=o;pt(()=>{o.searchText=(a||"").trim(),o.activeSearchItem=-1})});function At(a){if(!o.searchMode||!o.currentEmojis.length)return;const u=b=>{B(a),o.activeSearchItem=ke(b,o.activeSearchItem,o.currentEmojis)};switch(a.key){case"ArrowDown":return u(!1);case"ArrowUp":return u(!0);case"Enter":if(o.activeSearchItem===-1)o.activeSearchItem=0;else return B(a),He(o.currentEmojis[o.activeSearchItem].id)}}function $t(a){const{target:u}=a,b=u.closest(".nav-button");if(!b)return;const y=parseInt(b.dataset.groupId,10);n.searchElement.value="",o.rawSearchText="",o.searchText="",o.activeSearchItem=-1,o.currentGroupIndex=o.groups.findIndex(w=>w.id===y)}function Lt(a){const{target:u,key:b}=a,y=w=>{w&&(B(a),w.focus())};switch(b){case"ArrowLeft":return y(u.previousElementSibling);case"ArrowRight":return y(u.nextElementSibling);case"Home":return y(u.parentElement.firstElementChild);case"End":return y(u.parentElement.lastElementChild)}}async function Bt(a){const u=await o.database.getEmojiByUnicodeOrName(a),b=[...o.currentEmojis,...o.currentFavorites].find(w=>w.id===a),y=b.unicode&&$(b,o.currentSkinTone);return await o.database.incrementFavoriteEmojiCount(a),{emoji:u,skinTone:o.currentSkinTone,...y&&{unicode:y},...b.name&&{name:b.name}}}async function He(a){const u=Bt(a);f("emoji-click-sync",u),f("emoji-click",await u)}function Dt(a){const{target:u}=a;if(!u.classList.contains("emoji"))return;B(a);const b=u.id.substring(4);He(b)}function he(a){o.currentSkinTone=a,o.skinTonePickerExpanded=!1,l("skintone-button"),f("skin-tone-change",{skinTone:a}),o.database.setPreferredSkinTone(a)}function Ot(a){const{target:{id:u}}=a,b=u&&u.match(/^skintone-(\d)/);if(!b)return;B(a);const y=parseInt(b[1],10);he(y)}function Mt(a){o.skinTonePickerExpanded=!o.skinTonePickerExpanded,o.activeSkinTone=o.currentSkinTone,o.skinTonePickerExpanded&&(B(a),ie(()=>l("skintone-list")))}s(()=>{o.skinTonePickerExpanded?n.skinToneDropdown.addEventListener("transitionend",()=>{o.skinTonePickerExpandedAfterAnimation=!0},{once:!0}):o.skinTonePickerExpandedAfterAnimation=!1});function Pt(a){if(!o.skinTonePickerExpanded)return;const u=async b=>{B(a),o.activeSkinTone=b};switch(a.key){case"ArrowUp":return u(ke(!0,o.activeSkinTone,o.skinTones));case"ArrowDown":return u(ke(!1,o.activeSkinTone,o.skinTones));case"Home":return u(0);case"End":return u(o.skinTones.length-1);case"Enter":return B(a),he(o.activeSkinTone);case"Escape":return B(a),o.skinTonePickerExpanded=!1,l("skintone-button")}}function Rt(a){if(o.skinTonePickerExpanded)switch(a.key){case" ":return B(a),he(o.activeSkinTone)}}async function Ft(a){const{relatedTarget:u}=a;(!u||u.id!=="skintone-list")&&(o.skinTonePickerExpanded=!1)}function Nt(a){o.rawSearchText=a.target.value}return{$set(a){ne(o,a)},$destroy(){i.abort()}}}const bo="https://cdn.jsdelivr.net/npm/emoji-picker-element-data@^1/en/emojibase/data.json",yo="en";var ko={categoriesLabel:"Categories",emojiUnsupportedMessage:"Your browser does not support color emoji.",favoritesLabel:"Favorites",loadingMessage:"Loading…",networkErrorMessage:"Could not load emoji.",regionLabel:"Emoji picker",searchDescription:"When search results are available, press up or down to select and enter to choose.",searchLabel:"Search",searchResultsLabel:"Search results",skinToneDescription:"When expanded, press up or down to select and enter to choose.",skinToneLabel:"Choose a skin tone (currently {skinTone})",skinTonesLabel:"Skin tones",skinTones:["Default","Light","Medium-Light","Medium","Medium-Dark","Dark"],categories:{custom:"Custom","smileys-emotion":"Smileys and emoticons","people-body":"People and body","animals-nature":"Animals and nature","food-drink":"Food and drink","travel-places":"Travel and places",activities:"Activities",objects:"Objects",symbols:"Symbols",flags:"Flags"}},vo=':host{--emoji-size:1.375rem;--emoji-padding:0.5rem;--category-emoji-size:var(--emoji-size);--category-emoji-padding:var(--emoji-padding);--indicator-height:3px;--input-border-radius:0.5rem;--input-border-size:1px;--input-font-size:1rem;--input-line-height:1.5;--input-padding:0.25rem;--num-columns:8;--outline-size:2px;--border-size:1px;--border-radius:0;--skintone-border-radius:1rem;--category-font-size:1rem;display:flex;width:min-content;height:400px}:host,:host(.light){color-scheme:light;--background:#fff;--border-color:#e0e0e0;--indicator-color:#385ac1;--input-border-color:#999;--input-font-color:#111;--input-placeholder-color:#999;--outline-color:#999;--category-font-color:#111;--button-active-background:#e6e6e6;--button-hover-background:#d9d9d9}:host(.dark){color-scheme:dark;--background:#222;--border-color:#444;--indicator-color:#5373ec;--input-border-color:#ccc;--input-font-color:#efefef;--input-placeholder-color:#ccc;--outline-color:#fff;--category-font-color:#efefef;--button-active-background:#555555;--button-hover-background:#484848}@media (prefers-color-scheme:dark){:host{color-scheme:dark;--background:#222;--border-color:#444;--indicator-color:#5373ec;--input-border-color:#ccc;--input-font-color:#efefef;--input-placeholder-color:#ccc;--outline-color:#fff;--category-font-color:#efefef;--button-active-background:#555555;--button-hover-background:#484848}}:host([hidden]){display:none}button{margin:0;padding:0;border:0;background:0 0;box-shadow:none;-webkit-tap-highlight-color:transparent}button::-moz-focus-inner{border:0}input{padding:0;margin:0;line-height:1.15;font-family:inherit}input[type=search]{-webkit-appearance:none}:focus{outline:var(--outline-color) solid var(--outline-size);outline-offset:calc(-1*var(--outline-size))}:host([data-js-focus-visible]) :focus:not([data-focus-visible-added]){outline:0}:focus:not(:focus-visible){outline:0}.hide-focus{outline:0}*{box-sizing:border-box}.picker{contain:content;display:flex;flex-direction:column;background:var(--background);border:var(--border-size) solid var(--border-color);border-radius:var(--border-radius);width:100%;height:100%;overflow:hidden;--total-emoji-size:calc(var(--emoji-size) + (2 * var(--emoji-padding)));--total-category-emoji-size:calc(var(--category-emoji-size) + (2 * var(--category-emoji-padding)))}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}.hidden{opacity:0;pointer-events:none}.abs-pos{position:absolute;left:0;top:0}.gone{display:none!important}.skintone-button-wrapper,.skintone-list{background:var(--background);z-index:3}.skintone-button-wrapper.expanded{z-index:1}.skintone-list{position:absolute;inset-inline-end:0;top:0;z-index:2;overflow:visible;border-bottom:var(--border-size) solid var(--border-color);border-radius:0 0 var(--skintone-border-radius) var(--skintone-border-radius);will-change:transform;transition:transform .2s ease-in-out;transform-origin:center 0}@media (prefers-reduced-motion:reduce){.skintone-list{transition-duration:.001s}}@supports not (inset-inline-end:0){.skintone-list{right:0}}.skintone-list.no-animate{transition:none}.tabpanel{overflow-y:auto;scrollbar-gutter:stable;-webkit-overflow-scrolling:touch;will-change:transform;min-height:0;flex:1;contain:content}.emoji-menu{display:grid;grid-template-columns:repeat(var(--num-columns),var(--total-emoji-size));justify-content:space-around;align-items:flex-start;width:100%}.emoji-menu.visibility-auto{content-visibility:auto;contain-intrinsic-size:calc(var(--num-columns)*var(--total-emoji-size)) calc(var(--num-rows)*var(--total-emoji-size))}.category{padding:var(--emoji-padding);font-size:var(--category-font-size);color:var(--category-font-color)}.emoji,button.emoji{font-size:var(--emoji-size);display:flex;align-items:center;justify-content:center;border-radius:100%;height:var(--total-emoji-size);width:var(--total-emoji-size);line-height:1;overflow:hidden;font-family:var(--emoji-font-family);cursor:pointer}@media (hover:hover) and (pointer:fine){.emoji:hover,button.emoji:hover{background:var(--button-hover-background)}}.emoji.active,.emoji:active,button.emoji.active,button.emoji:active{background:var(--button-active-background)}.onscreen .custom-emoji::after{content:"";width:var(--emoji-size);height:var(--emoji-size);background-repeat:no-repeat;background-position:center center;background-size:contain;background-image:var(--custom-emoji-background)}.nav,.nav-button{align-items:center}.nav{display:grid;justify-content:space-between;contain:content}.nav-button{display:flex;justify-content:center}.nav-emoji{font-size:var(--category-emoji-size);width:var(--total-category-emoji-size);height:var(--total-category-emoji-size)}.indicator-wrapper{display:flex;border-bottom:1px solid var(--border-color)}.indicator{width:calc(100%/var(--num-groups));height:var(--indicator-height);opacity:var(--indicator-opacity);background-color:var(--indicator-color);will-change:transform,opacity;transition:opacity .1s linear,transform .25s ease-in-out}@media (prefers-reduced-motion:reduce){.indicator{will-change:opacity;transition:opacity .1s linear}}.pad-top,input.search{background:var(--background);width:100%}.pad-top{height:var(--emoji-padding);z-index:3}.search-row{display:flex;align-items:center;position:relative;padding-inline-start:var(--emoji-padding);padding-bottom:var(--emoji-padding)}.search-wrapper{flex:1;min-width:0}input.search{padding:var(--input-padding);border-radius:var(--input-border-radius);border:var(--input-border-size) solid var(--input-border-color);color:var(--input-font-color);font-size:var(--input-font-size);line-height:var(--input-line-height)}input.search::placeholder{color:var(--input-placeholder-color)}.favorites{overflow-y:auto;scrollbar-gutter:stable;display:flex;flex-direction:row;border-top:var(--border-size) solid var(--border-color);contain:content}.message{padding:var(--emoji-padding)}';const yt=["customEmoji","customCategorySorting","database","dataSource","i18n","locale","skinToneEmoji","emojiVersion"],Eo=`:host{--emoji-font-family:${gt}}`;class kt extends HTMLElement{constructor(e){super(),this.attachShadow({mode:"open"});const n=document.createElement("style");n.textContent=vo+Eo,this.shadowRoot.appendChild(n),this._ctx={locale:yo,dataSource:bo,skinToneEmoji:Dn,customCategorySorting:Pn,customEmoji:null,i18n:ko,emojiVersion:null,...e};for(const i of yt)i!=="database"&&Object.prototype.hasOwnProperty.call(this,i)&&(this._ctx[i]=this[i],delete this[i]);this._dbFlush()}connectedCallback(){this._cmp||(this._cmp=go(this.shadowRoot,this._ctx))}disconnectedCallback(){le(()=>{if(!this.isConnected&&this._cmp){this._cmp.$destroy(),this._cmp=void 0;const{database:e}=this._ctx;e.close().catch(n=>console.error(n))}})}static get observedAttributes(){return["locale","data-source","skin-tone-emoji","emoji-version"]}attributeChangedCallback(e,n,i){this._set(e.replace(/-([a-z])/g,(r,o)=>o.toUpperCase()),e==="emoji-version"?parseFloat(i):i)}_set(e,n){this._ctx[e]=n,this._cmp&&this._cmp.$set({[e]:n}),["locale","dataSource"].includes(e)&&this._dbFlush()}_dbCreate(){const{locale:e,dataSource:n,database:i}=this._ctx;(!i||i.locale!==e||i.dataSource!==n)&&this._set("database",new An({locale:e,dataSource:n}))}_dbFlush(){le(()=>this._dbCreate())}}const vt={};for(const t of yt)vt[t]={get(){return t==="database"&&this._dbCreate(),this._ctx[t]},set(e){if(t==="database")throw new Error("database is read-only");this._set(t,e)}};Object.defineProperties(kt.prototype,vt);customElements.get("emoji-picker")||customElements.define("emoji-picker",kt);et(()=>import("./chatModal-aOSSjCMn.js"),[]);const wo="https://binarybandits-profileapi.onrender.com/api/profile",D=document.getElementById("chatList"),j=document.getElementById("messages"),Et=document.getElementById("chatHeader"),z=document.getElementById("chatForm"),F=document.getElementById("messageInput");document.getElementById("backBtn");const v=z.querySelector("button[type=submit]"),wt=document.getElementById("emojiButton"),M=document.getElementById("emojiPicker"),To=3,So=1e3;let P=[],x=null,W=[],de=null,Ae=null,re=!1,ae=!1,G=null,E=null,Te={};function ue(t){try{return new URLSearchParams(window.location.search).get(t)}catch(e){return console.error("Error parsing query parameters:",e),null}}const Se=ue("targetUser");F.addEventListener("input",function(){this.style.height="auto",this.style.height=this.scrollHeight+"px",v.disabled=!this.value.trim()});v.disabled=!0;wt.addEventListener("click",()=>{if(M.style.display=M.style.display==="none"?"block":"none",!document.getElementById("emojiBackBtn")){const t=document.createElement("button");t.id="emojiBackBtn",t.textContent="Back",t.style.cssText="position:absolute;top:8px;right:8px;z-index:2;background:#e5e7eb;border:none;border-radius:6px;padding:4px 12px;cursor:pointer;font-size:1rem;",t.onclick=()=>{M.style.display="none"},M.appendChild(t)}});M.addEventListener("emoji-click",t=>{const e=t.detail.unicode,n=F,i=n.selectionStart,r=n.selectionEnd,o=n.value;n.value=o.slice(0,i)+e+o.slice(r),n.selectionStart=n.selectionEnd=i+e.length,n.focus()});document.addEventListener("click",t=>{M.style.display==="block"&&!M.contains(t.target)&&t.target!==wt&&(M.style.display="none")});function V(t){if(!t)return"";const e=document.createElement("div");return e.textContent=t,e.innerHTML}function jo(t){if(!t)return"";try{const e=typeof t=="number"?new Date(t):t.toDate?t.toDate():new Date(t);if(isNaN(e.getTime()))return"";const i=new Date-e;return Math.floor(i/36e5)<24?e.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):e.toLocaleDateString([],{month:"short",day:"numeric"})}catch(e){return console.error("Error formatting time:",e),""}}async function Z(t,e=To){for(let n=0;n<e;n++)try{return await t()}catch(i){if(n===e-1)throw i;await new Promise(r=>setTimeout(r,So*(n+1)))}}async function A(t,e={}){e.headers=e.headers||{},e.headers.Authorization=`Bearer ${G}`,e.headers["Content-Type"]="application/json";const n=await fetch(t,e);if(!n.ok){const i=await n.text();throw new Error(i||`Request failed with status ${n.status}`)}return n.json()}function Me(t,e,n=!0){t.innerHTML=`
        <div class="error-message">
          ${V(e)}
          ${n?'<button class="retry-btn" onclick="location.reload()">Retry</button>':""}
        </div>
      `}async function Pe(t=null){if(re)return;re=!0;let e=`${API_BASE}/chats?pageSize=20`;t&&(e+=`&pageToken=${t}`);try{const n=await Z(()=>A(e));if(P=t?P.concat(n.chats||[]):n.chats||[],Ae=n.nextPageToken,await Tt(),Se&&E){let i=P.find(r=>r.participants.some(o=>o.uid===Se));if(i)await fe(i);else{const r=ue("targetUsername");Et.innerHTML=`
              <span class="chat-avatar" style="display:inline-block;width:32px;height:32px;border-radius:50%;background:#c7d2fe;margin-right:10px;vertical-align:middle;">
                <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle;">
                  <circle cx="16" cy="16" r="16" fill="#e0e7ff"/>
                  <ellipse cx="16" cy="13" rx="7" ry="7" fill="#6366f1"/>
                  <ellipse cx="16" cy="25" rx="10" ry="6" fill="#a5b4fc"/>
                </svg>
              </span>
              <span style="vertical-align:middle;">${V(r||Se)}</span>`,W=[],j.innerHTML='<div class="no-messages">No messages yet. Start the conversation!</div>'}}}catch(n){console.error("Error loading chats:",n),Me(D,"Failed to load chats. Please try again.")}finally{re=!1}}async function Re(t,e=null){if(!t||ae)return;ae=!0;let n=`${API_BASE}/chats/${t.chatId}/messages?pageSize=20`;e&&(n+=`&pageToken=${e}`);try{const i=await Z(()=>A(n));W=e?(i.messages||[]).concat(W):i.messages||[],de=i.nextPageToken,await xo()}catch(i){console.error("Error loading messages:",i),Me(j,"Failed to load messages. Please try again.")}finally{ae=!1}}async function Fe(t){if(!x){const e=ue("targetUser"),n=ue("targetUsername");if(!e||!n){alert("No chat selected and no target user.");return}v.disabled=!0,v.textContent="Creating chat...";try{let i=null;try{const c=await fetch(`${wo}`,{headers:{Authorization:`Bearer ${G}`}});c.ok&&(i=(await c.json()).username||null)}catch(c){console.warn("Could not fetch current user username",c)}if(!i){alert("Could not fetch your username."),v.disabled=!1,v.textContent="Send";return}const o=(await Z(()=>A(`${API_BASE}/chats`,{method:"POST",body:JSON.stringify({participants:[{uid:E,username:i},{uid:e,username:n}]})}))).chatId;if(!o)throw new Error("Chat creation failed: No chatId returned");let s=null;try{const c=await Z(()=>A(`${API_BASE}/chats/${o}`));c&&c.chat&&(s={chatId:o,...c.chat})}catch(c){console.warn("Could not fetch new chat details",c)}if(!s&&(await Pe(),s=P.find(c=>c.chatId===o),!s))throw new Error("Chat creation failed: Chat not found");x=s,await Fe(t)}catch(i){console.error("Error creating chat:",i),alert("Failed to create chat. Please try again.")}finally{v.disabled=!1,v.textContent="Send"}return}try{v.disabled=!0,v.textContent="Sending...",await Z(()=>A(`${API_BASE}/chats/${x.chatId}/messages`,{method:"POST",body:JSON.stringify({text:t})})),await Re(x),F.value="",F.style.height="auto",v.disabled=!0}catch(e){console.error("Error sending message:",e),alert("Failed to send message. Please try again.")}finally{v.textContent="Send"}}async function fe(t){x=t;const e=P.find(l=>l.chatId===x.chatId);e?.lastMessage&&(e.lastMessage.status="read"),W=[],de=null;const n=t.participants.find(l=>l.uid!==E),i=n?n.uid:null,r=n?n.username:"Unknown";let o=!1,s=!1;try{const l=await A(`/api/moderation/listBlocked/${E}`);o=Array.isArray(l.blocked)&&i&&l.blocked.includes(i)}catch{o=!1}if(i)try{const l=await A(`/api/moderation/isBanned/${i}`);s=l&&l.banned}catch{s=!1}Et.innerHTML=`
        <button id="backBtn" class="back-btn" aria-label="Back to chat list" style="display:none;">←</button>
        <span class="chat-avatar" style="display:inline-block;width:32px;height:32px;border-radius:50%;background:#c7d2fe;margin-right:10px;vertical-align:middle;">
          <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle;">
            <circle cx="16" cy="16" r="16" fill="#e0e7ff"/>
            <ellipse cx="16" cy="13" rx="7" ry="7" fill="#6366f1"/>
            <ellipse cx="16" cy="25" rx="10" ry="6" fill="#a5b4fc"/>
          </svg>
        </span>
        <span style="vertical-align:middle; color:${o?"#ef4444":s?"#b91c1c":"inherit"}; font-weight:${o||s?"600":"inherit"};">
          ${V(r)}
          ${o?' <span style="color:#ef4444;font-weight:600">(Blocked)</span>':""}
          ${s?' <span style="color:#b91c1c;font-weight:600">(Banned)</span>':""}
        </span>
        <button id="blockUserBtn" style="margin-left:16px;padding:7px 18px;background:${o?"#f3f4f6":"#ef4444"};color:${o?"#ef4444":"#fff"};border:none;border-radius:5px;cursor:pointer;float:right;min-width:90px;">${o?"Unblock":"Block"}</button>
      `;const c=document.getElementById("blockUserBtn");if(c&&(c.onclick=async()=>{if(i)try{o?await A("/api/moderation/unblock",{method:"POST",body:JSON.stringify({uid:E,targetUid:i})}):await A("/api/moderation/block",{method:"POST",body:JSON.stringify({uid:E,targetUid:i})}),await fe(t)}catch(l){alert("Failed to update block status: "+l)}}),s){v.disabled=!0,z.disabled=!0,z.onsubmit=l=>l.preventDefault(),v.onclick=l=>l.preventDefault(),v.textContent="User is banned",v.style.background="#b91c1c",v.style.color="#fff",j.innerHTML='<div class="no-messages" style="color:#b91c1c;font-weight:600"><span class="empty-icon">🚫</span> This user has been banned. You cannot send messages.</div>';return}v.textContent=o?"Unblock":"Send",v.disabled=!1,z.disabled=!1,z.onsubmit=async l=>{l.preventDefault();const d=F.value.trim();d&&await Fe(d)},v.style.background="",v.style.color="",v.onclick=null,o&&(v.onclick=async l=>{if(l.preventDefault(),!!i)try{await A("/api/moderation/unblock",{method:"POST",body:JSON.stringify({uid:E,targetUid:i})}),await fe(t)}catch{alert("Failed to unblock user.")}}),await Tt(),await Re(t)}async function Tt(){if(!P.length){D.innerHTML='<div class="no-chat"><span class="empty-icon">🗨️</span> No chats yet. Start a conversation from your dashboard!</div>';return}let t=[];try{const e=await A(`/api/moderation/listBlocked/${E}`);t=Array.isArray(e.blocked)?e.blocked:[]}catch{t=[]}D.innerHTML="";for(const e of P){const n=e.participants.find(l=>l.uid!==E),i=n?n.uid:null,r=n?n.username:"Unknown",o=i&&t.includes(i),s=e.lastMessage?.status==="unread"&&e.lastMessage?.senderId!==E,c=document.createElement("div");c.className="chat-item"+(x?.chatId===e.chatId?" active":""),c.setAttribute("tabindex","0"),c.setAttribute("role","button"),c.setAttribute("aria-label",`Chat with ${r}`),c.innerHTML=`
          <div class="chat-user" style="display:flex; align-items:center; gap:6px; overflow:hidden;">
            <span class="username" style="white-space:nowrap; text-overflow:ellipsis; overflow:hidden;">
              ${V(r)}${o?" (Blocked)":""}
            </span>
            ${s?'<span class="unread-dot" style="flex-shrink:0;width:10px;height:10px;border-radius:50%;background:#c084fc;"></span>':""}
          </div>
        `,c.onclick=()=>{(!x||x.chatId!==e.chatId)&&fe(e)},c.onkeydown=l=>{(l.key==="Enter"||l.key===" ")&&c.click()},D.appendChild(c)}D.onscroll=()=>{D.scrollTop+D.clientHeight>=D.scrollHeight-10&&Ae&&!re&&Pe(Ae)}}async function xo(){let t=!1;if(x){const n=x.participants.find(r=>r.uid!==E),i=n?n.uid:null;try{const r=await A(`/api/moderation/listBlocked/${E}`);t=Array.isArray(r.blocked)&&i&&r.blocked.includes(i)}catch{t=!1}}if(!W.length||t){j.innerHTML=t?'<div class="no-messages" style="color:#ef4444;font-weight:600"><span class="empty-icon">🚫</span> You have blocked this user. Unblock to view messages.</div>':'<div class="no-messages"><span class="empty-icon">💬</span> No messages yet. Start the conversation!</div>';return}const e=j.scrollTop+j.clientHeight>=j.scrollHeight-100;j.innerHTML="";for(const n of W){const i=document.createElement("div"),r=n.senderId!==E;i.className="message"+(n.senderId===E?" me":""),i.innerHTML=`
          <div class="message-text">${V(n.text)}</div>
          <div class="timestamp">${jo(n.timestamp)}</div>
        `,r&&(i.style.cursor="pointer",i.title="Click to flag this message",i.onclick=()=>{et(async()=>{const{showModal:o}=await import("./chatModal-aOSSjCMn.js");return{showModal:o}},[]).then(({showModal:o})=>{let s="";o({title:"Flag Message",content:`<div style='margin-bottom:8px;'>Flag this message as inappropriate?</div><div style='background:#f3f4f6;padding:8px;border-radius:5px;margin-bottom:10px;'>${V(n.text)}</div><textarea id='flag-reason' placeholder='Reason (optional)' style='width:100%;min-height:48px;resize:vertical;'></textarea>`,confirmText:"Flag",cancelText:"Cancel",onConfirm:async()=>{const c=document.getElementById("flag-reason");s=c?c.value.trim():"";try{const l=x.participants.find(p=>p.uid!==E),d=l?l.uid:null,f=l?l.username:null;let h=null;if(x&&Array.isArray(x.participants)){const p=x.participants.find(T=>T.uid===E);h=p&&p.username?p.username:null}!h&&Te&&Te[E]&&(h=Te[E]);const m=await fetch("/api/moderation/report",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${G}`},body:JSON.stringify({reporterUid:E,reporterUsername:h,reportedUid:d,reportedUsername:f,flaggedMessage:n.text,reason:s,messageId:n.id})});if(m.status===409){alert("This message has already been reported.");return}if(!m.ok){const p=await m.json().catch(()=>({}));throw new Error(p.error||"Failed to flag user")}alert("User reported")}catch(l){alert("Failed to flag user "+(l.message||l))}}})})}),j.appendChild(i),i.classList.add("fade-in")}e&&(j.scrollTop=j.scrollHeight)}z.onsubmit=async t=>{t.preventDefault();const e=F.value.trim();e&&await Fe(e)};j.onscroll=()=>{if(j.scrollTop<40&&de&&!ae){const t=j.scrollHeight;Re(x,de).then(()=>{const e=j.scrollHeight;j.scrollTop=e-t})}};async function Io(t){E=t.uid;try{G=await t.getIdToken(),await Pe(),zt(async n=>{if(n){const i=await n.getIdToken();i!==G&&(console.log("Token refreshed"),G=i)}})}catch(e){console.error("Error starting chat app:",e),Me(D,"Failed to initialize chat. Please refresh the page.")}}Ut(async t=>{t?(await Io(t),v.disabled=!F.value.trim()):(alert("You must be logged in to use chat. Redirecting to login..."),window.location.href="/pages/login.html")});
