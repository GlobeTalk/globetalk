import"./modulepreload-polyfill-B5Qt9EMX.js";import{s as p,o as T}from"./firebase-BrtCog--.js";import{i as f,a as S}from"./admin-CP7GV2WY.js";const i={API_BASE_URL:"https://binarybandits-auth.onrender.com",PAGES:{LOGIN:"../../../pages/login.html",DASHBOARD:"../../../pages/userdashboard.html",ONBOARDING:"../../../pages/onboarding.html",ADMIN_DASHBOARD:"../../../pages/admin.html"},STORAGE_KEYS:{ID_TOKEN:"idToken",POLICIES_ACCEPTED:"policiesAccepted",USER_PREFERENCES:"userPreferences"},RETRY_CONFIG:{MAX_ATTEMPTS:3,DELAY_MS:1e3,BACKOFF_MULTIPLIER:2}};class l extends Error{constructor(e,o,n={}){super(e),this.name="AuthError",this.code=o,this.details=n}}class h extends Error{constructor(e,o,n={}){super(e),this.name="NetworkError",this.status=o,this.details=n}}const d={setSecureToken(t,e=1){const o=Date.now()+e*60*60*1e3,n={token:t,expiration:o};localStorage.setItem(i.STORAGE_KEYS.ID_TOKEN,JSON.stringify(n))},getSecureToken(){try{const t=JSON.parse(localStorage.getItem(i.STORAGE_KEYS.ID_TOKEN));return!t||Date.now()>t.expiration?(localStorage.removeItem(i.STORAGE_KEYS.ID_TOKEN),null):t.token}catch{return localStorage.removeItem(i.STORAGE_KEYS.ID_TOKEN),null}},sanitizeUserId(t){if(!t||typeof t!="string")throw new l("Invalid user ID","INVALID_USER_ID");return t.trim()},async safeNavigate(t,e=null){try{if(e&&(e.style.display="block"),await new Promise(o=>setTimeout(o,500)),!t||!t.startsWith("./")||!t.startsWith("../"))throw new Error("Invalid navigation URL");window.location.href=t}catch(o){throw console.error("Navigation error:",o),e&&(e.style.display="none"),new l("Navigation failed","NAVIGATION_ERROR",{url:t})}},retryOperation:async function(e,o=i.RETRY_CONFIG.MAX_ATTEMPTS){let n;for(let r=1;r<=o;r++)try{return await e()}catch(c){if(n=c,console.warn(`Attempt ${r}/${o} failed:`,c.message),r<o){const a=i.RETRY_CONFIG.DELAY_MS*Math.pow(i.RETRY_CONFIG.BACKOFF_MULTIPLIER,r-1);await new Promise(s=>setTimeout(s,a))}}throw n},debounce(t,e){let o;return function(...r){const c=()=>{clearTimeout(o),t(...r)};clearTimeout(o),o=setTimeout(c,e)}}};async function w(t){try{const e=d.sanitizeUserId(t);return await d.retryOperation(async()=>{const o=d.getSecureToken();if(!o)throw new l("No valid authentication token","NO_TOKEN");const n=new AbortController,r=setTimeout(()=>n.abort(),1e4);try{const c=await fetch(`${i.API_BASE_URL}/api/users/${e}/exists`,{method:"GET",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},signal:n.signal});if(clearTimeout(r),!c.ok){const s=await c.json().catch(()=>({}));throw new h(`Server error: ${c.status}`,c.status,s)}const a=await c.json();if(typeof a.exists!="boolean")throw new l("Invalid server response format","INVALID_RESPONSE");return a.exists}finally{clearTimeout(r)}})}catch(e){throw console.error("Error checking user existence:",e),e instanceof l||e instanceof h?e:new l("Failed to check user existence","USER_CHECK_FAILED",{originalError:e.message})}}class O{constructor(){this.loadingStates=new Set}setLoading(e,o,n="Loading..."){o?(this.loadingStates.add(e),e.disabled=!0,e.dataset.originalText=e.textContent,e.textContent=n,e.classList.add("loading")):(this.loadingStates.delete(e),e.disabled=!1,e.textContent=e.dataset.originalText||e.textContent,e.classList.remove("loading"))}showMessage(e,o="info",n=5e3){let r=document.getElementById("auth-message");r||(r=document.createElement("div"),r.id="auth-message",r.style.cssText=`
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 16px;
        border-radius: 4px;
        color: white;
        font-weight: 500;
        z-index: 1000;
        max-width: 300px;
        word-wrap: break-word;
      `,document.body.appendChild(r));const c={success:"#10b981",error:"#ef4444",warning:"#f59e0b",info:"#3b82f6"};r.style.backgroundColor=c[o]||c.info,r.textContent=e,r.style.display="block",setTimeout(()=>{r&&(r.style.display="none")},n)}}document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("loginBtn"),e=document.getElementById("privacy"),o=document.getElementById("consent");if(!t||!e||!o){console.error("Required DOM elements not found");return}const n=new O;let r=!1;const c=d.debounce(()=>{try{const a=localStorage.getItem(i.STORAGE_KEYS.POLICIES_ACCEPTED)==="true",s=e.checked&&o.checked;t.disabled=!(a||s),t.title=t.disabled?"Please accept both privacy policy and consent terms":"Sign in with Google"}catch(a){console.error("Error updating button state:",a)}},100);c(),e.addEventListener("change",c),o.addEventListener("change",c),t.addEventListener("click",async a=>{if(a.preventDefault(),!t.disabled){n.setLoading(t,!0,"Signing in...");try{const s=e.checked&&o.checked;if(!(localStorage.getItem(i.STORAGE_KEYS.POLICIES_ACCEPTED)==="true")&&!s)throw new l("Please accept both privacy policy and consent terms","POLICIES_NOT_ACCEPTED");const{user:u}=await p();if(console.log("✅ Google sign-in successful:",u),!u||!u.uid)throw new l("Invalid user data received","INVALID_USER_DATA");const g=await d.retryOperation(()=>u.getIdToken(!0));if(await f(u.uid,g))throw new l("Your account is banned.","USER_BANNED");d.setSecureToken(g),localStorage.setItem(i.STORAGE_KEYS.POLICIES_ACCEPTED,"true");const A=await S(u.uid,g),I=await w(u.uid);A?await d.safeNavigate(i.PAGES.ADMIN_DASHBOARD):I&&await d.safeNavigate(i.PAGES.DASHBOARD)}catch(s){console.error("❌ Login failed:",s);let E="Login failed. Please try again.";s instanceof l?E=s.message:s instanceof h&&(E=s.status>=500?"Server error":"Network error"),n.showMessage(E,"error")}finally{n.setLoading(t,!1)}}}),t.addEventListener("keydown",a=>{(a.key==="Enter"||a.key===" ")&&!t.disabled&&(a.preventDefault(),t.click())}),T(async a=>{if(!r){r=!0;try{if(!a){localStorage.removeItem(i.STORAGE_KEYS.ID_TOKEN),await d.safeNavigate(i.PAGES.LOGIN);return}const s=await d.retryOperation(()=>a.getIdToken(!0));if(d.setSecureToken(s),await f(a.uid,s))throw new l("Your account has been banned.","USER_BANNED");const u=await S(a.uid,s),g=await w(a.uid);u?await d.safeNavigate(i.PAGES.ADMIN_DASHBOARD):g?await d.safeNavigate(i.PAGES.DASHBOARD):await d.safeNavigate(i.PAGES.ONBOARDING)}catch(s){console.error("[AuthState] Error:",s)}finally{r=!1}}}),window.addEventListener("beforeunload",()=>r=!1),window.addEventListener("unhandledrejection",a=>{console.error("Unhandled promise rejection:",a.reason),n.showMessage("An unexpected error occurred. Please refresh the page.","error")})});
