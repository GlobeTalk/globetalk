<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GlobeTalk - Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../src/frontend/styles/userdashboard.css">
</head>
<body>
    <div class="min-h-screen">
        <!-- Navigation -->
        <nav>
            <a href="userdashboard.html" class="nav-link">Home</a>
            <a href="findPal.html" class="nav-link">Find Pen Pal</a>
            <a href="settings.html" class="nav-link">Settings & Safety</a>
            <button id="logoutBtn" class="nav-link">Logout</button>
        </nav>

        <!-- Main Content -->
        <div class="main-content">
            <!-- GlobeTalk branding -->
            <h1 class="globetalk-title">GlobeTalk</h1>

            <!-- Dashboard Title -->
            <div class="dashboard-title-container">
                <h2 class="dashboard-title">Dashboard</h2>
            </div>

            <!-- Pen Pal Suggestions Section -->
            <div class="section">
                <h3 class="section-title">Pen Pal Suggestions</h3>
                <div class="cards-container" id="penPalCards">
                    <span>Loading...</span>
                </div>
            </div>

            <!-- Active Conversations Section -->
            <div class="section">
                <h3 class="section-title">Active Conversations</h3>
                <div class="conversations-container" id="conversationsContainer">
                    <span>Loading...</span>
                </div>
            </div>
        </div>
    </div>
    <script type="module">
        
        import { auth, logout } from '../src/services/firebase.js';
        import { onAuthStateChanged } from "firebase/auth";

        // Constants
        const MAX_RETRY_ATTEMPTS = 3;
        const RETRY_DELAY = 1000;
        const AUTH_TIMEOUT = 10000;

        // Utility function to format time
        function formatTimeAgo(date) {
            try {
                if (!date) return 'Unknown';
                
                const timestamp = date instanceof Date ? date : new Date(date);
                if (isNaN(timestamp.getTime())) return 'Unknown';

                const now = new Date();
                const diffMs = now - timestamp;
                
                if (diffMs < 0) return 'Just now';
                
                const diffSec = Math.floor(diffMs / 1000);
                if (diffSec < 60) return `${diffSec}s ago`;
                
                const diffMin = Math.floor(diffSec / 60);
                if (diffMin < 60) return `${diffMin}m ago`;
                
                const diffHr = Math.floor(diffMin / 60);
                if (diffHr < 24) return `${diffHr}h ago`;
                
                const diffDay = Math.floor(diffHr / 24);
                if (diffDay < 7) return `${diffDay} day${diffDay !== 1 ? 's' : ''} ago`;
                
                const diffWeek = Math.floor(diffDay / 7);
                if (diffWeek < 4) return `${diffWeek} week${diffWeek !== 1 ? 's' : ''} ago`;
                
                return timestamp.toLocaleDateString();
            } catch (error) {
                console.error('Error formatting time:', error);
                return 'Unknown';
            }
        }

        // Retry logic for failed operations
        async function retryOperation(operation, attempts = MAX_RETRY_ATTEMPTS) {
            for (let i = 0; i < attempts; i++) {
                try {
                    return await operation();
                } catch (error) {
                    if (i === attempts - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, RETRY_DELAY * (i + 1)));
                }
            }
        }

        // Safe HTML escaping
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Render pen pal suggestions
        async function renderPenPalSuggestions(userId) {
            const penPalCards = document.getElementById('penPalCards');
            if (!penPalCards) return;

            try {
                penPalCards.innerHTML = '<span>Loading pen pal suggestions...</span>';
                
                const { getPenPalSuggestions } = await import('../src/services/userdashboard.js');
                const suggestions = await retryOperation(() => getPenPalSuggestions(userId));
                
                penPalCards.innerHTML = '';
                
                if (!suggestions || suggestions.length === 0) {
                    penPalCards.innerHTML = '<span style="color: #666;">No pen pal suggestions available at the moment. Check back later!</span>';
                    return;
                }

                suggestions.forEach(user => {
                    try {
                        const card = document.createElement('div');
                        card.className = 'pen-pal-card';
                        card.setAttribute('role', 'button');
                        card.setAttribute('tabindex', '0');
                        
                        const username = escapeHtml(user?.username || 'Unknown User');
                        const region = escapeHtml(user?.region || 'N/A');
                        const hobbies = Array.isArray(user?.hobbies) && user.hobbies.length 
                            ? user.hobbies.map(h => escapeHtml(h)).join(', ') 
                            : 'N/A';
                        const languages = Array.isArray(user?.languages) && user.languages.length 
                            ? user.languages.map(l => escapeHtml(l)).join(', ') 
                            : 'N/A';
                        
                        card.innerHTML = `
                            <h4>${username}</h4>
                            <div class="pen-pal-info">
                                <p><strong>Region:</strong> ${region}</p>
                                <p><strong>Hobbies:</strong> ${hobbies}</p>
                                <p><strong>Languages:</strong> ${languages}</p>
                            </div>
                        `;
                        
                        const navigateToProfile = () => {
                            if (user?._docId) {
                                window.location.href = `../pages/profile.html?userId=${encodeURIComponent(user._docId)}`;
                            } else {
                                console.error('User ID not available');
                                alert('Unable to view this profile. Please try again.');
                            }
                        };
                        
                        card.onclick = navigateToProfile;
                        card.onkeypress = (e) => {
                            if (e.key === 'Enter' || e.key === ' ') {
                                e.preventDefault();
                                navigateToProfile();
                            }
                        };
                        
                        penPalCards.appendChild(card);
                    } catch (cardError) {
                        console.error('Error rendering pen pal card:', cardError);
                    }
                });
            } catch (error) {
                console.error('Error loading pen pal suggestions:', error);
                penPalCards.innerHTML = `
                    <span style="color: #d32f2f;">
                        Unable to load pen pal suggestions. 
                        <button onclick="location.reload()" style="margin-left: 10px;">
                            Retry
                        </button>
                    </span>
                `;
            }
        }

        // Render active conversations
        async function renderActiveConversations(userId) {
            const container = document.getElementById('conversationsContainer');
            if (!container) return;

            try {
                container.innerHTML = '<span>Loading conversations...</span>';
                
                const response = await retryOperation(async () => {
                    const token = await auth.currentUser.getIdToken();
                    const resp = await fetch('/api/chat/latest', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    if (!resp.ok) {
                        throw new Error('Failed to fetch conversations');
                    }
                    return resp.json();
                });
                const chats = response.chats || [];
                container.innerHTML = '';
                if (chats.length === 0) {
                    container.innerHTML = '<span style="color: #666;">No active conversations yet. Find a pen pal to start chatting!</span>';
                    return;
                }
                chats.forEach(conv => {
                    try {
                        const item = document.createElement('div');
                        item.className = 'conversation-item';
                        item.setAttribute('role', 'button');
                        item.setAttribute('tabindex', '0');
                        // Find the other participant
                        const otherUserId = (conv.participants || []).find(uid => uid !== userId);
                        const otherUser = otherUserId ? escapeHtml(otherUserId) : 'Unknown';
                        // Handle Firestore Timestamp object or JS Date
                        let lastUpdated = conv.lastUpdated;
                        if (lastUpdated && typeof lastUpdated === 'object' && typeof lastUpdated.toDate === 'function') {
                            lastUpdated = lastUpdated.toDate();
                        }
                        const timeAgo = formatTimeAgo(lastUpdated);
                        let previewText = 'No messages yet';
                        if (conv.lastMessage && conv.lastMessage.text) {
                            previewText = escapeHtml(conv.lastMessage.text.substring(0, 50)) + (conv.lastMessage.text.length > 50 ? '...' : '');
                        }
                        item.innerHTML = `
                            <div>
                                <h4>${otherUser}</h4>
                                <small style="color: #666;">${previewText}</small>
                            </div>
                            <span class="conversation-time">${timeAgo}</span>
                        `;
                        const navigateToChat = () => {
                            if (conv.chatId) {
                                window.location.href = `../pages/chats.html?id=${encodeURIComponent(conv.chatId)}`;
                            }
                        };
                        item.onclick = navigateToChat;
                        item.onkeypress = (e) => {
                            if (e.key === 'Enter' || e.key === ' ') {
                                e.preventDefault();
                                navigateToChat();
                            }
                        };
                        container.appendChild(item);
                    } catch (convError) {
                        console.error('Error rendering conversation item:', convError);
                    }
                });
            } catch (error) {
                console.error('Error loading conversations:', error);
                container.innerHTML = `
                    <span style="color: #d32f2f;">
                        Unable to load conversations. 
                        <button onclick="location.reload()" style="margin-left: 10px;">
                            Retry
                        </button>
                    </span>
                `;
            }
        }

        // Handle logout
        async function handleLogout() {
            const logoutBtn = document.getElementById('logoutBtn');
            if (!logoutBtn) return;

            logoutBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                
                try {
                    logoutBtn.disabled = true;
                    logoutBtn.textContent = 'Logging out...';
                    
                    await logout();
                    window.location.href = '../pages/login.html';
                } catch (error) {
                    console.error('Logout error:', error);
                    alert('Failed to log out. Please try again.');
                    logoutBtn.disabled = false;
                    logoutBtn.textContent = 'Logout';
                }
            });
        }

        // Initialize dashboard
        async function initializeDashboard() {
            try {
                handleLogout();

                // Set up auth timeout
                const authTimeout = setTimeout(() => {
                    console.error('Authentication timeout');
                    window.location.href = '../pages/login.html';
                }, AUTH_TIMEOUT);

                onAuthStateChanged(auth, async (user) => {
                    clearTimeout(authTimeout);
                    
                    if (!user) {
                        console.log('No authenticated user, redirecting to login');
                        window.location.href = '../pages/login.html';
                        return;
                    }

                    const userId = user.uid;
                    
                    // Load both sections concurrently
                    await Promise.allSettled([
                        renderPenPalSuggestions(userId),
                        renderActiveConversations(userId)
                    ]);
                });
            } catch (error) {
                console.error('Dashboard initialization error:', error);
                alert('Failed to initialize dashboard. Please refresh the page.');
            }
        }

        // Start when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeDashboard);
        } else {
            initializeDashboard();
        }
    </script>
</body>
</html>